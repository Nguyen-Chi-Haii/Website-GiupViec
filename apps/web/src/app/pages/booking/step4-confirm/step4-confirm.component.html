<div class="booking-step">
  <!-- Progress Bar -->
  <div class="progress-bar">
    <div class="progress-step completed">
      <span class="step-number">‚úì</span>
      <span class="step-label">Ch·ªçn D·ªãch V·ª•</span>
    </div>
    <div class="progress-line active"></div>
    <div class="progress-step completed">
      <span class="step-number">‚úì</span>
      <span class="step-label">L·ªãch & ƒê·ªãa Ch·ªâ</span>
    </div>
    <div class="progress-line active"></div>
    <div class="progress-step completed">
      <span class="step-number">‚úì</span>
      <span class="step-label">Ch·ªçn Helper</span>
    </div>
    <div class="progress-line active"></div>
    <div class="progress-step active">
      <span class="step-number">4</span>
      <span class="step-label">X√°c Nh·∫≠n</span>
    </div>
  </div>

  <!-- Main Card -->
  <div class="card-container">
    <div class="card-header">
      <span class="material-symbols-outlined header-icon">task_alt</span>
      <h1 class="card-title">X√°c Nh·∫≠n ƒê·∫∑t D·ªãch V·ª•</h1>
      <p class="card-subtitle">Ki·ªÉm tra l·∫°i th√¥ng tin tr∆∞·ªõc khi x√°c nh·∫≠n</p>
    </div>

    <!-- Success Message -->
    @if (successMessage()) {
      <div class="message success">
        <span class="material-symbols-outlined">check_circle</span>
        <p>{{ successMessage() }}</p>
      </div>
    }

    <!-- Error Message -->
    @if (errorMessage()) {
      <div class="message error">
        <span class="material-symbols-outlined">error</span>
        <p>{{ errorMessage() }}</p>
      </div>
    }

    <!-- Summary Sections -->
    @if (!successMessage()) {
      <div class="summary-sections">
        <!-- Service Info -->
        <div class="summary-section">
          <div class="section-header">
            <span class="material-symbols-outlined">cleaning_services</span>
            <h3>Th√¥ng Tin D·ªãch V·ª•</h3>
          </div>
          <div class="section-content">
            <div class="info-row">
              <span class="label">D·ªãch v·ª•:</span>
              <span class="value">{{ selectedService?.name }}</span>
            </div>
            <div class="info-row">
              <span class="label">ƒê∆°n gi√°:</span>
              <span class="value highlight">{{ formatPrice(selectedService?.price || 0) }}/{{ selectedService?.unitLabel || 'gi·ªù' }}</span>
            </div>
            <div class="info-row">
              <span class="label">Ng∆∞·ªùi th·ª±c hi·ªán:</span>
              <span class="value">
                @if (autoAssignHelper) {
                  <em>H·ªá th·ªëng t·ª± ƒë·ªông ch·ªçn</em>
                } @else if (selectedHelper) {
                  {{ selectedHelper.fullName }}
                }
              </span>
            </div>
          </div>
        </div>

        <!-- Schedule Info -->
        <div class="summary-section">
          <div class="section-header">
            <span class="material-symbols-outlined">calendar_month</span>
            <h3>L·ªãch L√†m Vi·ªác</h3>
          </div>
          <div class="section-content">
            <div class="info-row">
              <span class="label">Ng√†y b·∫Øt ƒë·∫ßu:</span>
              <span class="value">{{ formatDate(schedule?.startDate || '') }}</span>
            </div>
            <div class="info-row">
              <span class="label">Ng√†y k·∫øt th√∫c:</span>
              <span class="value">{{ formatDate(schedule?.endDate || '') }}</span>
            </div>
            <div class="info-row">
              <span class="label">Gi·ªù l√†m vi·ªác:</span>
              <span class="value">{{ formatTime(schedule?.workShiftStart || '') }} - {{ formatTime(schedule?.workShiftEnd || '') }}</span>
            </div>
          </div>
        </div>

        <!-- Address Info -->
        <div class="summary-section">
          <div class="section-header">
            <span class="material-symbols-outlined">location_on</span>
            <h3>ƒê·ªãa Ch·ªâ</h3>
          </div>
          <div class="section-content">
            <div class="info-row full">
              <span class="value">{{ address?.fullAddress }}</span>
            </div>
            @if (notes) {
              <div class="info-row full">
                <span class="label">Ghi ch√∫:</span>
                <span class="value note">{{ notes }}</span>
              </div>
            }
          </div>
        </div>

        <!-- Price Summary -->
        <div class="summary-section price-section">
          <div class="section-header">
            <span class="material-symbols-outlined">payments</span>
            <h3>Chi Ph√≠</h3>
          </div>
          <div class="section-content">
            <div class="info-row">
              <span class="label">{{ selectedService?.unit === 'Hour' ? 'S·ªë gi·ªù l√†m' : 'S·ªë l∆∞·ª£ng' }}:</span>
              <span class="value">{{ displayQuantity }} {{ selectedService?.unitLabel || 'gi·ªù' }}</span>
            </div>
            <div class="info-row">
              <span class="label">ƒê∆°n gi√°:</span>
              <span class="value">{{ formatPrice(selectedService?.price || 0) }}/{{ selectedService?.unitLabel || 'gi·ªù' }}</span>
            </div>
            <div class="divider"></div>
            <div class="info-row total">
              <span class="label">T·ªîNG C·ªòNG:</span>
              <span class="value">{{ formatPrice(totalPrice) }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Terms -->
      <div class="terms-section">
        <label class="terms-checkbox">
          <input 
            type="checkbox" 
            [checked]="agreeTerms()"
            (change)="agreeTerms.set($any($event.target).checked)"
          />
          <span>T√¥i ƒë·ªìng √Ω v·ªõi <a href="#">ƒêi·ªÅu kho·∫£n s·ª≠ d·ª•ng</a> v√† <a href="#">Ch√≠nh s√°ch b·∫£o m·∫≠t</a></span>
        </label>
      </div>

      <!-- Navigation -->
      <div class="card-footer">
        <button class="btn btn-outline" (click)="onBack()" [disabled]="isSubmitting()">
          <span class="material-symbols-outlined">arrow_back</span>
          Quay L·∫°i
        </button>
        <button 
          class="btn btn-primary btn-submit" 
          (click)="onSubmit()"
          [disabled]="isSubmitting()"
        >
          @if (isSubmitting()) {
            <span class="spinner"></span>
            <span>ƒêang x·ª≠ l√Ω...</span>
          } @else {
            <span class="material-symbols-outlined">lock</span>
            <span>X√°c Nh·∫≠n ƒê·∫∑t D·ªãch V·ª•</span>
          }
        </button>
      </div>
    } @else if (guestBookingResult()) {
      <!-- Guest Booking Success Modal -->
      <div class="guest-result">
        <div class="guest-result-icon">
          <span class="material-symbols-outlined">check_circle</span>
        </div>
        <h2>ƒê·∫∑t L·ªãch Th√†nh C√¥ng!</h2>
        <p class="result-message">{{ guestBookingResult()!.message }}</p>
        
        <div class="credentials-box">
          <h4>üîê Th√¥ng Tin T√†i Kho·∫£n</h4>
          <div class="credential-row">
            <span class="credential-label">Email:</span>
            <span class="credential-value">{{ guestBookingResult()!.customerEmail }}</span>
          </div>
          <div class="credential-row">
            <span class="credential-label">M·∫≠t kh·∫©u t·∫°m:</span>
            <span class="credential-value password">{{ guestBookingResult()!.tempPassword }}</span>
          </div>
          <p class="warning">‚ö†Ô∏è Vui l√≤ng ƒëƒÉng nh·∫≠p v√† ƒë·ªïi m·∫≠t kh·∫©u ngay sau khi nh·∫≠n ƒë∆∞·ª£c th√¥ng tin n√†y!</p>
        </div>

        <div class="booking-summary-mini">
          <h4>üìã Th√¥ng Tin ƒê∆°n H√†ng</h4>
          <div class="summary-row">
            <span>M√£ ƒë∆°n:</span>
            <strong>#{{ guestBookingResult()!.bookingId }}</strong>
          </div>
          <div class="summary-row">
            <span>D·ªãch v·ª•:</span>
            <span>{{ guestBookingResult()!.serviceName }}</span>
          </div>
          <div class="summary-row">
            <span>T·ªïng ti·ªÅn:</span>
            <strong class="price">{{ formatPrice(guestBookingResult()!.totalPrice) }}</strong>
          </div>
        </div>

        <button class="btn btn-primary" (click)="onCloseGuestResult()">
          <span class="material-symbols-outlined">login</span>
          ƒêƒÉng Nh·∫≠p Ngay
        </button>
      </div>
    } @else {
      <!-- Success State for logged-in users -->
      <div class="success-state">
        <span class="material-symbols-outlined success-icon">celebration</span>
        <p>ƒêang chuy·ªÉn h∆∞·ªõng v·ªÅ trang ch·ªß...</p>
      </div>
    }
  </div>
</div>
